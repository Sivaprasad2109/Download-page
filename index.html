<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Downloads - StudyMint Portal</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background-color: #f0f4ff;
  color: #002b5c;
}
nav {
  background-color: #002b5c;
  padding: 10px 20px;
  display: flex;
  justify-content: space-around;
  box-shadow: 0 4px 15px rgba(0, 43, 92, 0.3);
}
nav a {
  color: white;
  text-decoration: none;
  font-weight: bold;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.3s ease, transform 0.2s ease;
}
nav a:hover {
  background-color: #004c99;
  transform: translateY(-2px);
}

.page { padding: 30px; animation: fadeIn 0.5s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.panel {
  background: white;
  padding: 25px;
  border-radius: 10px;
  box-shadow: 0 8px 25px rgba(0,43,92,0.15);
  max-width: 800px;
  margin: 40px auto;
  text-align: center;
}

.btn {
  background-color: #004c99;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 10px;
  transition: all 0.3s ease;
  font-size: 1rem;
}
.btn:hover { background-color: #003d7a; transform: translateY(-2px); }
.download-btn { background-color: #28a745; }
.download-btn:hover { background-color: #218838; }

.search-container {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: center;
}
#category-filter, #search-bar {
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}
#search-bar { flex-grow: 1; }

.download-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px;
  margin: 15px 0;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
  cursor: pointer;
  transition: all 0.3s ease;
}
.download-item:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,43,92,0.15);
  border-color: #004c99;
  background-color: #fff;
}
.file-name { font-weight: bold; color: #002b5c; }
.file-tags { color: #5a7a9a; font-size: 0.8em; margin-top: 4px; }

/* Modals */
.modal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-color: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  z-index: 1000;
}
.modal.show { visibility: visible; opacity: 1; }

.modal-content {
  background: white;
  border-radius: 10px;
  width: 90%;
  max-width: 500px;
  padding: 25px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  text-align: center;
}
.modal-content h2 { margin-top: 0; color: #002b5c; }
.modal-content input {
  width: 90%; padding: 10px; margin: 10px 0;
  border: 1px solid #ccc; border-radius: 6px;
}
.modal-content input:focus {
  border-color: #004c99;
  box-shadow: 0 0 0 3px rgba(0,76,153,0.1);
}
.message-success { color:#28a745; font-weight: bold; }
.message-error { color:#dc3545; font-weight: bold; }
</style>
</head>
<body>

<nav>
  <a href="index.html" target="_blank">Home / Login</a>
  <a href="#">Downloads</a>
</nav>

<div id="download" class="page active">
  <div class="panel">
    <h2>Download Section</h2>
    <div class="search-container">
      <select id="category-filter" onchange="applyFiltersAndSearch()">
        <option value="">All Categories</option>
      </select>
      <input type="text" id="search-bar" onkeyup="applyFiltersAndSearch()" placeholder="Search by name or tag...">
    </div>
    <div id="downloadList"></div>
  </div>
</div>

<!-- Password Confirmation Modal -->
<div id="passwordModal" class="modal" onclick="closeModal(event)">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h2>Confirm Password</h2>
    <input type="password" id="confirmPasswordInput" placeholder="Enter your password" required>
    <p id="passwordMsg"></p>
    <button class="btn" onclick="verifyPasswordAndDownload()">Confirm & Download</button>
    <button class="btn" style="background:#dc3545;" onclick="hideModal('passwordModal')">Cancel</button>
  </div>
</div>

<script>
const API_URL = "https://login-page-for-studymint-3.onrender.com";
let allFiles = [];
let currentFileId = null;

function loadDownloads() {
  const list = document.getElementById("downloadList");
  list.innerHTML = "<p>Loading files...</p>";
  fetch(`${API_URL}/get-downloads`)
    .then(res => res.json())
    .then(data => {
      allFiles = data.files || [];
      populateCategoryFilter(allFiles);
      applyFiltersAndSearch();
    })
    .catch(() => list.innerHTML = "<p>Failed to load files.</p>");
}

function populateCategoryFilter(files) {
  const filter = document.getElementById('category-filter');
  const categories = [...new Set(files.map(f => f.category).filter(Boolean))];
  filter.innerHTML = '<option value="">All Categories</option>';
  categories.forEach(cat => {
    const opt = document.createElement('option');
    opt.value = cat;
    opt.innerText = cat;
    filter.appendChild(opt);
  });
}

function applyFiltersAndSearch() {
  const cat = document.getElementById('category-filter').value.toLowerCase();
  const term = document.getElementById('search-bar').value.toLowerCase();
  let filtered = allFiles;
  if (cat) filtered = filtered.filter(f => f.category && f.category.toLowerCase() === cat);
  if (term) filtered = filtered.filter(f => f.name.toLowerCase().includes(term));
  renderDownloads(filtered);
}

function renderDownloads(files) {
  const list = document.getElementById("downloadList");
  list.innerHTML = "";
  if (!files.length) { list.innerHTML = "<p>No matching files found.</p>"; return; }
  files.forEach(f => {
    const div = document.createElement("div");
    div.className = "download-item";
    div.innerHTML = `
      <div>
        <div class="file-name">${f.name}</div>
        <div class="file-tags">${f.tags ? f.tags.join(', ') : ''}</div>
      </div>
      <button class="btn download-btn" onclick="handleDownload('${f.id}')">Download (10 SM Coins)</button>`;
    list.appendChild(div);
  });
}

/* --- DOWNLOAD FLOW --- */
function handleDownload(fileId) {
  currentFileId = fileId;
  const isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
  const email = localStorage.getItem("userEmail");

  if (!isLoggedIn || !email) {
    alert("Please log in via the main StudyMint portal first.");
    return;
  }

  showModal('passwordModal');
}

// REPLACE the old verifyPasswordAndDownload function with this one

// REPLACE the function in download-page/index.html with this

async function verifyPasswordAndDownload() {
  const email = localStorage.getItem("userEmail");
  const password = document.getElementById("confirmPasswordInput").value;
  const msg = document.getElementById("passwordMsg");

  if (!password) {
    msg.textContent = "Enter your password.";
    msg.style.color = "#dc3545";
    return;
  }

  msg.innerHTML = "Verifying...";

  try {
    // Step 1: Verify the password (This is correct)
    const res = await fetch(`${API_URL}/verify-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const result = await res.json();

    if (!result.success) {
      msg.textContent = "Incorrect password. Try again.";
      msg.style.color = "#dc3545";
      return;
    }

    // Step 2: Password is correct.
    msg.textContent = "Password verified âœ… Initiating download...";
    msg.style.color = "#28a745";

    // --- THIS IS THE FIX ---
    // We will no longer call /download-file-deduct.
    // We will now build the URL to the /download-file endpoint
    // which streams the file directly from your server.
    
    const directDownloadUrl = `${API_URL}/download-file?email=${encodeURIComponent(email)}&fileId=${encodeURIComponent(currentFileId)}`;

    // Step 3: Open the direct stream endpoint in a new tab.
    // The server will send the file, forcing a download.
    
    hideModal('passwordModal');
    const newWindow = window.open(directDownloadUrl, '_blank');
    
    if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
      alert("Download blocked by your browser. Please ALLOW popups for this site to download files.");
    }

    // Clear password and message
    document.getElementById("confirmPasswordInput").value = "";
    msg.textContent = "";

  } catch (err) {
    msg.textContent = "Server error. Try later.";
    msg.style.color = "#dc3545";
  }
}

// REPLACE the old triggerDownload function in download-page/index.html with this:

// This function attempts to open the download in a new tab,
// which gets around the "allow-downloads" sandbox error.

// In download-page/index.html - KEEP THIS CODE

function showModal(id) {
  const m = document.getElementById(id);
  m.classList.add("show");
}
function hideModal(id) {
  const m = document.getElementById(id);
  m.classList.remove("show");
}
function closeModal(e) {
  if (e.target.classList.contains("modal")) hideModal(e.target.id);
}

window.onload = loadDownloads;
</script>
</body>
</html>








